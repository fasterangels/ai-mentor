# Release: on tag v*.*.* build Windows desktop and publish GitHub Release with NSIS + MSI.
name: release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write
    defaults:
      run:
        shell: cmd

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          clean: true
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          # cache disabled to avoid stale CI build source
          # cache: "npm"
          # cache-dependency-path: app/frontend/package-lock.json

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Install NSIS
        run: choco install nsis -y

      - name: Install backend dependencies
        run: python -m pip install -U pip && pip install -r backend/requirements.txt

      - name: Install frontend dependencies
        working-directory: app/frontend
        run: npm ci

      - name: Setup backend Python deps (incl. PyInstaller)
        shell: pwsh
        run: |
          python -V
          python -m pip install --upgrade pip
          python -m pip install -r backend/requirements.txt
          python -m pip install pyinstaller
          python -c "import PyInstaller; print('PyInstaller OK:', PyInstaller.__version__)"

      - name: Build backend exe
        run: |
          if not exist packaging\artifacts mkdir packaging\artifacts
          python -m PyInstaller packaging\backend_sidecar\pyinstaller_sidecar.spec --noconfirm
          if not exist app\frontend\src-tauri\bin mkdir app\frontend\src-tauri\bin

      - name: Verify PyInstaller backend output exists and is non-trivial
        shell: pwsh
        run: |
          $src = Join-Path $env:GITHUB_WORKSPACE "dist\ai-mentor-backend.exe"
          if (!(Test-Path $src)) { throw "Missing PyInstaller output at $src" }
          $len = (Get-Item $src).Length
          Write-Host "PyInstaller exe size: $len bytes ($src)"
          if ($len -lt 102400) { throw "PyInstaller exe is too small (<100KB). Build output is broken." }

      - name: Copy backend exe to Tauri bin
        shell: pwsh
        run: |
          $src = Join-Path $env:GITHUB_WORKSPACE "dist\ai-mentor-backend.exe"
          $bin = Join-Path $env:GITHUB_WORKSPACE "app\frontend\src-tauri\bin"
          if (!(Test-Path $src)) { throw "PyInstaller output missing: $src" }
          Copy-Item -Path $src -Destination (Join-Path $bin "ai-mentor-backend-x86_64-pc-windows-msvc.exe") -Force
          Copy-Item -Path $src -Destination (Join-Path $bin "ai-mentor-backend.exe") -Force
          Copy-Item -Path (Join-Path $env:GITHUB_WORKSPACE "packaging\windows_task\launch_backend.cmd") -Destination (Join-Path $bin "launch_backend.cmd") -Force

      - name: Inspect backend exe (size + hash)
        shell: pwsh
        run: |
          $exe = "app/frontend/src-tauri/bin/ai-mentor-backend.exe"
          if (!(Test-Path $exe)) { throw "Missing backend exe at $exe" }
          Get-Item $exe | Format-List FullName,Length,LastWriteTimeUtc
          Get-FileHash $exe -Algorithm SHA256

      - name: Επαληθεύστε ότι το backend exe είναι x64 (γρήγορη αποτυχία)
        shell: pwsh
        run: |
          $exe = "app/frontend/src-tauri/bin/ai-mentor-backend.exe"
          if (!(Test-Path $exe)) { throw "Missing backend exe at $exe" }


          $len = (Get-Item $exe).Length
          Write-Host "Backend exe size: $len bytes"
          if ($len -lt 102400) { throw "Backend exe is too small (<100KB). Truncated or wrong file was copied." }


          $fs = [System.IO.File]::OpenRead($exe)
          $br = New-Object System.IO.BinaryReader($fs)
          try {
            # MZ
            $fs.Seek(0, 'Begin') | Out-Null
            $mz1 = $br.ReadByte(); $mz2 = $br.ReadByte()
            if ($mz1 -ne 0x4D -or $mz2 -ne 0x5A) { throw "Not a Windows EXE (missing MZ header)." }


            # PE offset
            $fs.Seek(0x3C, 'Begin') | Out-Null
            $peOffset = $br.ReadInt32()
            if ($peOffset -lt 0 -or $peOffset -gt ($len - 256)) { throw "Invalid PE header offset: $peOffset (corrupted/truncated file)." }


            # PE\0\0
            $fs.Seek($peOffset, 'Begin') | Out-Null
            $p1 = $br.ReadByte(); $p2 = $br.ReadByte(); $p3 = $br.ReadByte(); $p4 = $br.ReadByte()
            if ($p1 -ne 0x50 -or $p2 -ne 0x45 -or $p3 -ne 0x00 -or $p4 -ne 0x00) { throw "Missing PE signature at offset $peOffset (corrupted/truncated file)." }


            # Machine
            $fs.Seek($peOffset + 4, 'Begin') | Out-Null
            $machine = $br.ReadUInt16()
            Write-Host ("Backend PE machine: 0x{0:X4}" -f $machine)


            if ($machine -ne 0x8664) { throw ("Backend exe is NOT x64. Expected 0x8664, got 0x{0:X4}." -f $machine) }


            Write-Host "OK: backend exe is valid PE and x64."
          } finally {
            $br.Close(); $fs.Close()
          }

      - name: Build frontend
        working-directory: app/frontend
        run: npm run build

      - name: Build Tauri (NSIS + MSI)
        working-directory: app/frontend
        run: npx tauri build

      - name: Set version from tag
        id: version
        shell: pwsh
        run: echo "ver=$('${{ github.ref_name }}'.TrimStart('v'))" >> $env:GITHUB_OUTPUT

      - name: Copy backend.log and ensure artifact files exist
        if: always()
        run: |
          if not exist packaging\artifacts mkdir packaging\artifacts
          if exist "%LOCALAPPDATA%\AI_Mentor\logs\backend.log" (
            copy /Y "%LOCALAPPDATA%\AI_Mentor\logs\backend.log" packaging\artifacts\backend.log
          ) else (
            echo Backend log not found. > packaging\artifacts\backend.log
          )
          if not exist packaging\artifacts\ci_build_stdout.txt (
            echo Build step did not run or failed before writing output. > packaging\artifacts\ci_build_stdout.txt
          )

      - name: Collect NSIS and MSI installers (consistent names)
        if: success()
        shell: pwsh
        env:
          TAG: ${{ github.ref_name }}
        run: |
          $tag = $env:TAG
          $ver = $tag.TrimStart('v')
          $artifactsDir = Join-Path $env:GITHUB_WORKSPACE "packaging/artifacts"
          if (-not (Test-Path $artifactsDir)) { New-Item -ItemType Directory -Path $artifactsDir -Force | Out-Null }

          $nsisCandidates = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse -Filter *.exe -File -ErrorAction SilentlyContinue |
            Where-Object { $_.FullName -match '\\target\\release\\bundle\\nsis\\' }
          if (-not $nsisCandidates -or $nsisCandidates.Count -eq 0) {
            Write-Error "No NSIS installer found under src-tauri/target/release/bundle/nsis/"
            exit 1
          }
          $nsisExe = $nsisCandidates | Sort-Object -Property LastWriteTime -Descending | Select-Object -First 1
          $nsisDest = Join-Path $artifactsDir "AI-Mentor-$ver-x64-setup.exe"
          Copy-Item -LiteralPath $nsisExe.FullName -Destination $nsisDest -Force
          Write-Host "NSIS: $nsisDest ($((Get-Item $nsisDest).Length) bytes)"

          $msiCandidates = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse -Filter *.msi -File -ErrorAction SilentlyContinue |
            Where-Object { $_.FullName -match '\\target\\release\\bundle\\msi\\' }
          if (-not $msiCandidates -or $msiCandidates.Count -eq 0) {
            Write-Error "No MSI installer found under src-tauri/target/release/bundle/msi/"
            exit 1
          }
          $msiFile = $msiCandidates | Sort-Object -Property LastWriteTime -Descending | Select-Object -First 1
          $msiDest = Join-Path $artifactsDir "AI-Mentor-$ver-x64.msi"
          Copy-Item -LiteralPath $msiFile.FullName -Destination $msiDest -Force
          Write-Host "MSI: $msiDest ($((Get-Item $msiDest).Length) bytes)"

      - name: Upload installers as workflow artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: installers-${{ github.ref_name }}
          path: |
            packaging/artifacts/AI-Mentor-${{ steps.version.outputs.ver }}-x64-setup.exe
            packaging/artifacts/AI-Mentor-${{ steps.version.outputs.ver }}-x64.msi

      - name: Create or update GitHub Release and upload assets
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          prerelease: false
          replace_assets: true
          files: |
            packaging/artifacts/AI-Mentor-${{ steps.version.outputs.ver }}-x64-setup.exe
            packaging/artifacts/AI-Mentor-${{ steps.version.outputs.ver }}-x64.msi
            packaging/artifacts/backend.log
            packaging/artifacts/ci_build_stdout.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
